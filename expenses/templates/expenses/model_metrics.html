{% extends 'base.html' %}

{% block title %}Expense Categorization Model Metrics{% endblock %}

{% block extra_css %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
    .progress {
        height: 25px;
    }
    .training-controls {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .training-status {
        margin-top: 15px;
    }
    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Expense Categorization Model Metrics</h1>

    <!-- Training Controls -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Model Training</h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-button">
                <i class="bi bi-arrow-clockwise"></i> Refresh Metrics
            </button>
        </div>
        <div class="card-body training-controls">
            <form id="training-form">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="model_type" id="enhanced-model" value="enhanced" checked>
                            <label class="form-check-label" for="enhanced-model">
                                Enhanced Model (Better accuracy, slower training)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="model_type" id="original-model" value="original">
                            <label class="form-check-label" for="original-model">
                                Original Model (Faster training, lower accuracy)
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="use-sample" name="use_sample">
                            <label class="form-check-label" for="use-sample">
                                Use Sample Data (Faster training for testing)
                            </label>
                        </div>
                        <div class="input-group mt-2 sample-size-group">
                            <span class="input-group-text">Sample Size</span>
                            <input type="number" class="form-control" id="sample-size" name="sample_size" value="100" min="10" max="1000">
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="train-button">Train Model</button>
            </form>

            <div class="training-status mt-3 hidden" id="training-status">
                <h6>Training Progress</h6>
                <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="training-progress" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="training-message">Initializing training...</p>
            </div>
        </div>
    </div>

    {% if metrics.status == 'error' %}
        <div class="alert alert-danger">
            {{ metrics.error }}
        </div>
    {% else %}
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Category Accuracy</h5>
                        <h2 class="card-text text-primary">{{ metrics.category_accuracy|floatformat:2 }}%</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">F1 Score</h5>
                        <h2 class="card-text text-success">{{ metrics.category_f1|floatformat:2 }}%</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Avg Subcategory Accuracy</h5>
                        <h2 class="card-text text-warning">{{ metrics.avg_subcategory_accuracy|floatformat:2 }}%</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Training Time</h5>
                        <h2 class="card-text text-info">{{ metrics.training_time_minutes|floatformat:2 }} min</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Metrics Card -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Category Model Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Accuracy</td>
                                            <td>{{ metrics.category_accuracy|floatformat:2 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Precision</td>
                                            <td>{{ metrics.category_precision|floatformat:2 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Recall</td>
                                            <td>{{ metrics.category_recall|floatformat:2 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>F1 Score</td>
                                            <td>{{ metrics.category_f1|floatformat:2 }}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <canvas id="categoryMetricsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Individual Model Performance -->
        {% if metrics.individual_model_metrics %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Individual Model Performance</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Model</th>
                                    <th>Accuracy</th>
                                    <th>Precision</th>
                                    <th>Recall</th>
                                    <th>F1 Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in metrics.individual_model_metrics %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ model.model_name }}</td>
                                    <td>{{ model.accuracy|floatformat:2 }}%</td>
                                    <td>{{ model.precision|floatformat:2 }}%</td>
                                    <td>{{ model.recall|floatformat:2 }}%</td>
                                    <td>{{ model.f1_score|floatformat:2 }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Top Performing Categories</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="topCategoriesChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Categories by Subcategory Count</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="subcategoryCountChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- More Charts Row -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Subcategory Accuracy by Category</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="accuracyByCategory"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tables Row -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Top 5 Performing Categories</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Accuracy</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, accuracy in metrics.top_categories %}
                                <tr>
                                    <td>{{ category }}</td>
                                    <td>{{ accuracy|floatformat:2 }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Bottom 5 Performing Categories</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Accuracy</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, accuracy in metrics.bottom_categories %}
                                <tr>
                                    <td>{{ category }}</td>
                                    <td>{{ accuracy|floatformat:2 }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Initialize Charts and Training Form -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Training form handling
        const trainingForm = document.getElementById('training-form');
        const trainButton = document.getElementById('train-button');
        const refreshButton = document.getElementById('refresh-button');
        const trainingStatus = document.getElementById('training-status');
        const trainingProgress = document.getElementById('training-progress');
        const trainingMessage = document.getElementById('training-message');
        const useSampleCheckbox = document.getElementById('use-sample');
        const sampleSizeGroup = document.querySelector('.sample-size-group');

        // Handle refresh button click
        refreshButton.addEventListener('click', function() {
            // Show a loading message
            refreshButton.disabled = true;
            refreshButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';

            // Force a hard reload to ensure metrics are refreshed
            window.location.href = window.location.href.split('?')[0] + '?refresh=' + new Date().getTime();
        });

        // Show/hide sample size input based on checkbox
        useSampleCheckbox.addEventListener('change', function() {
            sampleSizeGroup.style.display = this.checked ? 'flex' : 'none';
        });

        // Initially hide sample size input if checkbox is unchecked
        sampleSizeGroup.style.display = useSampleCheckbox.checked ? 'flex' : 'none';

        // Check if training is already in progress
        {% if training_status.is_training %}
            trainingStatus.classList.remove('hidden');
            trainButton.disabled = true;
            updateTrainingProgress({{ training_status.progress }}, "{{ training_status.message }}");
            pollTrainingStatus();
        {% endif %}

        // Handle form submission
        trainingForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Get form data
            const formData = new FormData(trainingForm);
            const modelType = document.querySelector('input[name="model_type"]:checked').value;
            formData.set('use_enhanced', modelType === 'enhanced' ? 'true' : 'false');

            // Disable form and show progress
            trainButton.disabled = true;
            trainingStatus.classList.remove('hidden');
            updateTrainingProgress(0, "Initializing training...");

            // Send training request
            fetch('/expenses/model-train/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateTrainingProgress(0, data.training_message);
                    pollTrainingStatus();
                } else {
                    updateTrainingProgress(-1, data.message);
                    setTimeout(() => {
                        trainButton.disabled = false;
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                updateTrainingProgress(-1, "Error starting training: " + error.message);
                setTimeout(() => {
                    trainButton.disabled = false;
                }, 3000);
            });
        });

        // Function to update progress bar and message
        function updateTrainingProgress(progress, message) {
            if (progress < 0) {
                // Error state
                trainingProgress.style.width = '100%';
                trainingProgress.classList.remove('bg-primary', 'bg-success');
                trainingProgress.classList.add('bg-danger');
                trainingMessage.textContent = message;
            } else if (progress >= 100) {
                // Complete state
                trainingProgress.style.width = '100%';
                trainingProgress.classList.remove('bg-primary', 'bg-danger');
                trainingProgress.classList.add('bg-success');
                trainingMessage.textContent = message;

                // Re-enable form after a delay and reload the page
                setTimeout(() => {
                    trainButton.disabled = false;
                    trainingMessage.textContent = message + " Refreshing page to show updated metrics...";

                    // Force a hard reload to ensure metrics are refreshed
                    window.location.href = window.location.href.split('?')[0] + '?refresh=' + new Date().getTime();
                }, 3000);
            } else {
                // In-progress state
                trainingProgress.style.width = progress + '%';
                trainingProgress.classList.remove('bg-success', 'bg-danger');
                trainingProgress.classList.add('bg-primary');
                trainingMessage.textContent = message;
            }
        }

        // Function to poll training status
        function pollTrainingStatus() {
            const pollInterval = setInterval(() => {
                fetch('/expenses/training-status/')
                .then(response => response.json())
                .then(data => {
                    updateTrainingProgress(data.progress, data.message);

                    // If training is complete or failed, stop polling
                    if (!data.is_training) {
                        clearInterval(pollInterval);
                    }
                })
                .catch(error => {
                    console.error('Error polling training status:', error);
                    // Don't stop polling on error, just log it
                });
            }, 1000); // Poll every second
        }

        // Initialize charts
        {% if metrics.status != 'error' %}
            // Category Metrics Chart
            const categoryMetricsCtx = document.getElementById('categoryMetricsChart').getContext('2d');
            const categoryMetricsChart = new Chart(categoryMetricsCtx, {
                type: 'radar',
                data: {
                    labels: ['Accuracy', 'Precision', 'Recall', 'F1 Score'],
                    datasets: [{
                        label: 'Model Performance',
                        data: [
                            {{ metrics.category_accuracy|floatformat:2 }},
                            {{ metrics.category_precision|floatformat:2 }},
                            {{ metrics.category_recall|floatformat:2 }},
                            {{ metrics.category_f1|floatformat:2 }}
                        ],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(75, 192, 192, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });

            // Top Categories Chart
            const topCategoriesCtx = document.getElementById('topCategoriesChart').getContext('2d');
            const topCategoriesChart = new Chart(topCategoriesCtx, {
                type: 'bar',
                data: {
                    labels: [
                        {% for category, accuracy in metrics.top_categories %}
                            '{{ category }}',
                        {% endfor %}
                    ],
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: [
                            {% for category, accuracy in metrics.top_categories %}
                                {{ accuracy|floatformat:2 }},
                            {% endfor %}
                        ],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Subcategory Count Chart
            const subcategoryCountCtx = document.getElementById('subcategoryCountChart').getContext('2d');
            const subcategoryCountData = {
                labels: [
                    {% for category, count in metrics.subcategory_counts.items|slice:":10" %}
                        '{{ category }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Number of Subcategories',
                    data: [
                        {% for category, count in metrics.subcategory_counts.items|slice:":10" %}
                            {{ count }},
                        {% endfor %}
                    ],
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            };
            const subcategoryCountChart = new Chart(subcategoryCountCtx, {
                type: 'bar',
                data: subcategoryCountData,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Accuracy by Category Chart
            const accuracyByCategoryCtx = document.getElementById('accuracyByCategory').getContext('2d');
            const accuracyByCategoryData = {
                labels: [
                    {% for category, accuracy in metrics.subcategory_accuracies.items|slice:":15" %}
                        '{{ category }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Accuracy (%)',
                    data: [
                        {% for category, accuracy in metrics.subcategory_accuracies.items|slice:":15" %}
                            {{ accuracy|floatformat:2 }},
                        {% endfor %}
                    ],
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            };
            const accuracyByCategoryChart = new Chart(accuracyByCategoryCtx, {
                type: 'bar',
                data: accuracyByCategoryData,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        {% endif %}
    });
</script>
{% endblock %}
